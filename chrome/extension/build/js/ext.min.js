define("background/msgRouter",[],function(){function t(){chrome.runtime.onMessage.addListener(this.messageListener.bind(this)),this.add=function(t,e){this[t]=e}}return t.prototype.map={},t.prototype.messageListener=function(t,e,o){try{var n=t.action;this.map[n]&&"function"==typeof this.map[n]&&this.map[n](t,e,o)}catch(r){console.warn("Message processing has failed. Let the developer know about that."+r)}},t.prototype.addListener=function(t,e){this.map[t]=e},new t}),define("background/localStorage",[],function(){function t(){}var e=window.localStorage;return t.prototype.setItem=function(t,o,n){try{e.setItem(t,n?o:JSON.stringify(o))}catch(r){return console.error("setItem fails",r),!1}return!0},t.prototype.getItem=function(t,o){var n;try{n=e.getItem(t),n=o?n:JSON.parse(n)}catch(r){return console.error("setItem fails",r),!1}return n},new t}),define("common/ExtMsgConstructor",[],function(){function t(t){if("undefined"==typeof t.action||"undefined"==typeof t.data)throw"Action and data properties are required";this.action=t.action,this.data=t.data,this.action.indexOf(this.actionPrefix)<0&&(this.action=this.addPrefix(this.action))}return t.prototype.actionPrefix="ts_ext_",t.prototype.addPrefix=function(t){var e=t.indexOf(this.actionPrefix)<0?this.actionPrefix+t:t;return e},t}),define("common/ActionsList",["common/ExtMsgConstructor"],function(t){var e=t.prototype.addPrefix.bind(t.prototype),o={popup:{startClick:e("popupStartButton"),needState:e("popupNeedState"),gotState:e("popupGotState")},content:{clipboardClick:e("getTicketData"),contextMenuClick:e("getTicketDataByContextMenu"),startTicketClick:e("startTicketClick"),gotTicketString:e("hereIsTheTicketString")},state:{need:e("generalNeedState"),got:e("generalGotState")},workedTime:{needUpdate:e("pleaseUpdateWorkedTime")}};return o}),define("common/NotifModule",[],function(){function t(t){t=t||{},this.defaultTimeout=t.timeout||3e3,this.defaultIcon=t.icon||"img/icon48.png"}return t.prototype.show=function(t){t=t||{};var e=new Notification(t.title||"",{icon:this.defaultIcon,body:t.body||""});return t.autoClose&&setTimeout(e.close.bind(e),this.defaultTimeout||t.timeout),e},new t}),define("background/state",["background/msgRouter","background/localStorage","common/ExtMsgConstructor","common/ActionsList","common/NotifModule"],function(t,e,o,n,r){function i(){}return i.prototype.d={started:!1,tickets:[],username:""},i.prototype.init=function(){return this.__init||(t.addListener(n.state.need,this.onMsgGetState.bind(this)),this.restoreState(),this.__init=!0),this},i.prototype.onMsgGetState=function(t,e,o){o(this.getState())},i.prototype.toggleDayStart=function(){var t=this.d;t.started?(t.started=!1,t.endTime=(new Date).getTime()):(t.started=!0,t.startTime=(new Date).getTime()),this.setState()},i.prototype.startTicket=function(t){if(this.validateTicketData(t)){this.d.tickets=this.d.tickets||[];var e,o;return o=t,this.d.tickets=[],e={id:o.id,subject:o.subject,queue:o.queue,started:(new Date).getTime()},this.d.tickets.push(e),this.setState(),r.show({title:"Ticket started",body:e.id+": "+e.subject,autoClose:!0}),e}},i.prototype.validateTicketData=function(t){return t.id&&t.queue&&t.subject},i.prototype.getTicketById=function(t){return this.d.tickets=this.d.tickets||[],this.d.tickets.filter(function(e){return e.id===t})[0]},i.prototype.setOptions=function(t){this.d;return t=t||t,this.d.opts=t,this.setState(),this.getState()},i.prototype.broadcastUpdateState=function(){chrome.runtime.sendMessage(new o({action:n.state.got,data:{state:this.d}}))},i.prototype.restoreState=function(){var t=this.getState();t&&(this.d=t)},i.prototype.setParam=function(t,e){this.d[t]=e,this.setState()},i.prototype.getParam=function(t){return this.getState()[t]},i.prototype.setState=function(){e.setItem("state",this.d),this.broadcastUpdateState()},i.prototype.getState=function(){return e.getItem("state")||{}},(new i).init()}),define("background/user",["background/state"],function(t){function e(){this.name="",this.lastNameError=""}return e.prototype.update=function(t){$.ajax({url:"http://localhost:5555/user",success:this.onUpdateUser.bind(this,t),error:this.onFailUpdateUser.bind(this,t)})},e.prototype.onUpdateUser=function(e,o,n,r){o?""===o?(this.lastNameError="Empty name",this.name=""):(this.lastNameError="",this.name=o):(this.lastNameError="unknown error",this.name=""),t.setParam("username",this.name),t.setParam("usernameError",this.lastNameError),e&&$.isFunction(e)&&e(o,r,n)},e.prototype.onFailUpdateUser=function(e,o,n){this.lastNameError="error: "+o.status,this.name="",t.setParam("username",""),t.setParam("usernameError",this.lastNameError),e&&$.isFunction(e)&&e(null,o,n)},e.prototype.getName=function(){return t.getParam("username")},e.prototype.getLastNameError=function(){return t.getParam("usernameError")},new e}),define("common/dates",[],function(){function t(){}return t.prototype.weekdays={full:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"short":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},t.prototype.months={full:["January","February","March","April","May","June","July","August","September","October","November","Decemeber"],"short":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},t.prototype.getFullDate=function(t,e){return this.getHumanDate(t)+" "+this.getHumanTime(t,e)},t.prototype.getHumanDate=function(t){var e,o,n;return t=new Date(t.getTime()),e=this.xx(t.getMonth()+1),o=this.xx(t.getDate()),n=t.getFullYear()+"-"+e+"-"+o},t.prototype.getHumanTime=function(t,e){var o,n,r,i;return o=this.xx(t.getHours()),n=this.xx(t.getMinutes()),r=this.xx(t.getSeconds()),i=o+":"+n+(e?":"+r:"")},t.prototype.xx=function(t){return t=parseInt(t,10),10>t?"0"+t:t+""},t.prototype.getDayName=function(t,e){e=e||{};var o=t||new Date;return this.weekdays[e["short"]?"short":"full"][o.getDay()]},t.prototype.getMonthName=function(t,e){e=e||{};var o=t||new Date;return this.months[e["short"]?"short":"full"][o.getMonth()]},new t}),define("background/record",["common/dates"],function(t){function e(){}return e.prototype.make=function(e){var o,n,r,i;e.subject=this.sanitizeSubject(e.subject);var s=[e.queue,e.id,e.subject];return s[1]="RT:"+s[1],s[2]='"'+s[2]+'"',n=new Date,o=t.getHumanDate(n),r=t.getHumanTime(n),n.setHours(10),n.setMinutes(0),i=t.getHumanTime(n),s.unshift(r),s.unshift(i),s.unshift(o),s=s.join(","),this.copy(s),s},e.prototype.copy=function(t){var e=document.createElement("div");e.contentEditable=!0,document.body.appendChild(e),e.innerHTML=t,e.unselectable="off",e.focus(),document.execCommand("SelectAll"),document.execCommand("Copy",!1,null),document.body.removeChild(e)},e.prototype.sanitizeSubject=function(t){var e;return e=t.replace(/"/gim,"'")},new e}),define("background/clickHandler",["background/record","common/ExtMsgConstructor","common/ActionsList"],function(t,e,o){function n(t,n){chrome.tabs.sendMessage(n.id,new e({action:o.content.contextMenuClick,data:""}),r.bind(this,t))}function r(e,o){o=o||{},t.make(o)}chrome.contextMenus.create({title:"Form TS rec and ctrl+C",contexts:["page","selection"],onclick:n})}),function(){function t(){function t(t){function e(){this.url=t.url||this.url,this.debug="undefined"!=typeof t.debug?t.debug:this.debug}return this.getTicket=function(t,e){var o;o=this.url+this.getTicketPattern.replace("%id%",t),this.ajax({method:"POST",url:o,success:this.onGetTicket.bind(this,e),error:this.onGetTicketError.bind(this,e)})},e.call(this)}var e={url:"http://rt.easter-eggs.org/demos/4.2/",getTicketPattern:"ticket/%id%/show",debug:!0,nonJqueryAjax:null,onGetTicket:function(t,e){var o=this.parseResponse(e);o.success?t&&"function"==typeof t&&t(o):this.debug&&console.error("Error getting ticket data: ",o.errorText||"<No error text>")},onGetTicketError:function(t,e){var o=e.statusText||"<No error text>";this.debug&&console.error("Error getting ticket data: ",o," Status: "+e.status),t&&"function"==typeof t&&t({success:!1,data:{},errorText:o})},parseResponse:function(t){var e,o,n,r,i,s,a,c;if(i={},a=!0,c="",e=t,e=e.split("\n"),o=e.shift(),n=e.shift(),r=e[0],!o||o.toLowerCase().indexOf("200 ok")<0||""!==n)c="Something went wrong, incorrect server answer structure.",a=!1;else if(r&&0===r.indexOf("#"))r=r.replace("#","").replace(/^\s+/gim,""),c=r,a=!1;else for(var u=0;u<e.length;u++)s=e[u],""!==s&&s&&s.indexOf(": ")&&(s=s.split(": "),s.length>=2&&("id"===s[0]&&(s[1]=s[1].replace("ticket/","")),i[s.shift().toLowerCase()]=s.join(":")));return{success:a,errorText:c,ticketData:i}},ajax:function(t){return this.nonJqueryAjax?this.nonJqueryAjax(t):$.ajax(t)}};for(var o in e)"function"==typeof e[o]?t.prototype[o]=e[o].bind(t.prototype):t.prototype[o]=e[o];return t}"function"==typeof define&&define.amd?define("background/rt",[],t):"object"==typeof module&&module.exports?module.exports=t:window.RTIConstructor=t()}(),define("background/listenContent",["background/record","background/msgRouter","background/state","background/rt","common/ExtMsgConstructor","common/ActionsList"],function(t,e,o,n,r,i){function s(e){return t.make.apply(t,[e])}function a(t){return o.startTicket(t)}function c(t,e,o){var n={};if(o=o||{},o.success&&o.ticketData){try{n=e(o.ticketData)}catch(s){console.error("Error while running keyFunction inside makeAnswer",s)}chrome.tabs.sendMessage(t,new r({action:i.content.gotTicketString,data:n}))}}function u(t,e){var o;if(!t.data||!t.data.id)throw"Ticket ID is required to get ticket info from RT";switch(t.action){case i.content.clipboardClick:o=s;break;case i.content.startTicketClick:o=a}d.getTicket(t.data.id,c.bind(this,e.tab.id,o))}e.addListener(i.content.clipboardClick,u),e.addListener(i.content.startTicketClick,u);var d=new n({url:"https://www.iponweb.net/rt/REST/1.0/"})}),define("common/BadgeModule",[],function(){function t(){this.defaultText="",this.defaultTitle="",this.defaultBgColor="#6D0073",this.loadingBgColor="#666666",this.finalRedColor="#DF0500",this.finalGreenColor="#00910D",this.detailedTemplate="Worked/total :: "}return t.prototype.setLoading=function(){this.setBadge({text:"...",title:"Updating...",bgColor:this.loadingBgColor})},t.prototype.setOverWorked=function(t,e){this.setWorked(t,e,this.finalGreenColor)},t.prototype.setUnderWorked=function(t,e){this.setWorked(t,e,this.finalRedColor)},t.prototype.setWorked=function(t,e,o){this.setBadge({text:t+"",title:this.detailedTemplate+e,bgColor:o})},t.prototype.setBadge=function(t){t=t||{},chrome.browserAction.setBadgeText({text:t.text||this.defaultText}),chrome.browserAction.setTitle({title:t.title||this.defaultTitle}),chrome.browserAction.setBadgeBackgroundColor({color:t.bgColor||this.defaultBgColor})},new t}),define("background/popupController",["background/state","background/user","common/ExtMsgConstructor","common/BadgeModule"],function(t,e,o,n){function r(){}return r.prototype.onStartClick=function(e,o,n){t.toggleDayStart(),n(t.d)},r.prototype.getWorkedTime=function(){this.worked={loading:!0},t.setParam("workedTime",this.worked),n.setLoading(),e.update(this._sendWorkedTimeRequest.bind(this))},r.prototype._sendWorkedTimeRequest=function(t){$.ajax({method:"GET",url:"https://www.iponweb.net/twiki/bin/view/IPonweb/TimesheetApril2016",timeout:1e4,success:this._onGetWorkedTime.bind(this,t),error:this._onFailedGetWorkedTime.bind(this)})},r.prototype._onGetWorkedTime=function(e,o){o||console.error("Empty worked time response");var r,i,s,a,c;r=o,s=r.match(/April2016 \(Working hours - (\d+)\)/),s=s&&s.length>0&&s[1]||"unknown",a=r.substring(r.indexOf(e)).split("\n").splice(0,3)[2],a=a.replace(/\s\s+|<td\s.+?>|<\/td>/gim,"").replace(/\s/gim,""),a=parseFloat(a),s&&"unknown"!==s&&!isNaN(a)?(i=s-a,c=i>0?"("+i.toFixed(1)+"h left)":"("+i+"h overworked)",this.workedTimeStr=a+"/"+s+" "+c,i=parseFloat(i.toFixed(1)),i>0?n.setUnderWorked("-"+i,this.workedTimeStr):n.setOverWorked("+"+i,this.workedTimeStr),this.worked={worked:parseFloat(a),total:parseFloat(s),rest:i,str:this.workedTimeStr}):(console.error("Error in worked time calculation, something has gone wrong"),this.worked={str:"Error"}),t.setParam("workedTime",this.worked)},r.prototype._onFailedGetWorkedTime=function(e){this.worked={worked:0,total:0,rest:0,str:"fail"},t.setParam("workedTime",this.worked),console.error("Failed to get worked time",e)},new r}),define("background/listenPopup",["background/msgRouter","background/popupController","common/ActionsList"],function(t,e,o){return t.addListener(o.popup.startClick,e.onStartClick.bind(e)),t.addListener(o.workedTime.needUpdate,e.getWorkedTime.bind(e)),{popupController:e}}),define("background/listenOptions",["background/msgRouter","background/state"],function(t,e){function o(t){try{e.setOptions(t.opts)}catch(o){}}t.addListener("setOptions",o)}),require(["background/user","background/clickHandler","background/listenContent","background/listenPopup","background/listenOptions"],function(t,e,o,n,r){function i(){this.onGotName=function(e){console.log("User name: ",t.getName()||t.getLastNameError()),n.popupController.getWorkedTime()}}var s=new i;t.update(s.onGotName.bind(s))}),define("BackgroundMain",function(){});
//# sourceMappingURL=ext.min.js.map